{"version":3,"names":["_processImage","_interopRequireDefault","require","_detectFiletype","_require","Buffer","_require2","parse","updateImageOrientation","file","options","arguments","length","undefined","_promise","default","resolve","reader","FileReader","readAsArrayBuffer","onload","arrayBuffer","result","buf","from","then","shouldNotAddExifData","readExifData","_x","_x2","_readExifData","apply","_asyncToGenerator2","_regenerator","mark","_callee","exifData","Orientation","ExifImageHeight","ExifImageWidth","wrap","_callee$","_context","prev","next","type","mimeType","translateValues","sent","orientation","exifHeight","exifWidth","image","abrupt","stop","orient","width","height","ctx","img","x","y","transform","drawImage"],"sources":["index.js"],"sourcesContent":["/*!\n * Copyright (c) 2015-2020 Cisco Systems, Inc. See LICENSE file.\n */\n\n/* eslint no-unused-vars: [\"error\", { \"vars\": \"local\" }] */\n// eslint-disable-next-line no-redeclare\n\nconst {Buffer} = require('safe-buffer');\nconst {parse} = require('exifr/dist/lite.umd');\n\n/**\n * Updates the image file with exif information, required to correctly rotate the image activity\n * @param {Object} file\n * @param {Object} options\n * @param {boolean} options.shouldNotAddExifData\n * @returns {Promise<Object>}\n */\nexport function updateImageOrientation(file, options = {}) {\n  return new Promise((resolve) => {\n    const reader = new FileReader();\n\n    reader.readAsArrayBuffer(file);\n    reader.onload = function onload() {\n      const arrayBuffer = reader.result;\n      const buf = Buffer.from(arrayBuffer);\n\n      resolve(buf);\n    };\n  }).then((buf) => {\n    if (options.shouldNotAddExifData) {\n      return buf;\n    }\n\n    return readExifData(file, buf);\n  });\n}\n\n/**\n * Adds exif orientation information on the image file\n * @param {Object} file\n * @param {Object} buf\n * @returns {Promise<ExifImage>}\n */\nexport async function readExifData(file, buf) {\n  // For avatar images the file.type is set as image/jpeg, however for images shared in an activity file.mimeType is set as image/jpeg. Handling both conditions.\n  if (file && (file.type === 'image/jpeg' || file.mimeType === 'image/jpeg')) {\n    const exifData = await parse(buf, {translateValues: false});\n\n    if (exifData) {\n      const {Orientation, ExifImageHeight, ExifImageWidth} = exifData;\n\n      file.orientation = Orientation;\n      file.exifHeight = ExifImageHeight;\n      file.exifWidth = ExifImageWidth;\n\n      if (file.image) {\n        file.image.orientation = Orientation;\n      }\n    }\n  }\n\n  return buf;\n}\n\n/* eslint-disable complexity */\n/**\n * Rotates/flips the image on the canvas as per exif information\n * @param {Object} options(orientation: image exif orientation range from 1-8, img: Image object, x: start x-axis, y: start y-axis, width: width of the thumbnail, height: height of the thumbnail, ctx: canvas context)\n * @param {Object} file\n * @returns {Object}\n */\nexport function orient(options, file) {\n  const {width, height, ctx, img, orientation, x, y} = options;\n\n  if (file && file.orientation && file.orientation !== 1) {\n    // explanation of orientation:\n    // https://stackoverflow.com/questions/20600800/js-client-side-exif-orientation-rotate-and-mirror-jpeg-images\n    switch (orientation) {\n      case 2:\n        // flip\n        ctx.transform(-1, 0, 0, 1, width, 0);\n        break;\n      case 3:\n        // rotateImage180\n        ctx.transform(-1, 0, 0, -1, width, height);\n        break;\n      case 4:\n        // rotate180AndFlipImage\n        ctx.transform(1, 0, 0, -1, 0, height);\n        break;\n      case 5:\n        // rotate90AndFlipImage\n        ctx.transform(0, 1, 1, 0, 0, 0);\n        break;\n      case 6:\n        // rotateImage90\n        ctx.transform(0, 1, -1, 0, height, 0);\n        break;\n      case 7:\n        // rotateNeg90AndFlipImage\n        ctx.transform(0, -1, -1, 0, height, width);\n        break;\n      case 8:\n        // rotateNeg90\n        ctx.transform(0, -1, 1, 0, 0, width);\n        break;\n      default:\n        break;\n    }\n  }\n  ctx.drawImage(img, x, y, width, height);\n}\n/* eslint-enable complexity */\n\nexport {default as processImage} from './process-image';\nexport {default as detectFileType} from './detect-filetype';\n"],"mappings":"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"}