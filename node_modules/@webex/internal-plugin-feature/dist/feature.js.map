{"version":3,"names":["require","_webexCore","Feature","WebexPlugin","extend","namespace","getFeature","keyType","key","options","_promise","default","reject","Error","feature","webex","internal","device","features","get","resolve","full","serialize","value","handleFeatureUpdate","envelope","data","featureToggle","type","toLowerCase","add","merge","listen","listenTo","mercury","setFeature","_this","request","method","api","resource","concat","userId","body","mutable","val","then","res","setBundledFeatures","featureList","_this2","forEach","item","partitionedToggles","_partition2","featureToggles","user","developer","initialize","_len","arguments","length","args","Array","_key","_apply","prototype","listenToAndRun","trigger","bind","version","_default","exports"],"sources":["feature.js"],"sourcesContent":["/*!\n * Copyright (c) 2015-2020 Cisco Systems, Inc. See LICENSE file.\n */\n\nimport '@webex/internal-plugin-device';\nimport {partition} from 'lodash';\nimport {WebexPlugin} from '@webex/webex-core';\n\nconst Feature = WebexPlugin.extend({\n  namespace: 'Feature',\n\n  /**\n   * Returns the value of the requested feature toggle.\n   * @param {string} keyType <developer|user|entitlement>\n   * @param {string} key\n   * @param {Object} options\n   * @param {boolean} options.full to get full feature record including metadata.\n   * @returns {string|boolean|number|FeatureModel|null}\n   */\n  getFeature(keyType, key, options) {\n    if (keyType !== 'developer' && keyType !== 'user' && keyType !== 'entitlement') {\n      return Promise.reject(\n        new Error(\n          'Invalid feature keyType provided. Only `developer`, `user`, and `entitlement` feature toggles are permitted.'\n        )\n      );\n    }\n\n    options = options || {};\n\n    const feature = this.webex.internal.device.features[keyType].get(key);\n\n    if (!feature) {\n      return Promise.resolve(null);\n    }\n\n    if (options.full) {\n      return Promise.resolve(feature.serialize());\n    }\n\n    return Promise.resolve(feature.value);\n  },\n\n  /**\n   * Handles a feature toggle update from the server.\n   * @param {Object} envelope\n   * @returns {undefined}\n   */\n  handleFeatureUpdate(envelope) {\n    if (envelope && envelope.data) {\n      const feature = envelope.data.featureToggle;\n      const keyType = feature.type.toLowerCase();\n\n      if (keyType === 'user' || keyType === 'developer') {\n        this.webex.internal.device.features[keyType].add([feature], {merge: true});\n      }\n    }\n  },\n\n  /**\n   * Register to listen for incoming feature events\n   * @instance\n   * @returns {undefined}\n   */\n  listen() {\n    this.listenTo(\n      this.webex.internal.mercury,\n      'event:featureToggle_update',\n      this.handleFeatureUpdate\n    );\n  },\n\n  /**\n   * Issues request to server to set a value for a feature toggle.\n   * @param {string} keyType <developer|user>\n   * @param {string} key\n   * @param {string} value\n   * @returns {Promise} Refreshes the local device and resolves with the features endpoint's response.\n   */\n  setFeature(keyType, key, value) {\n    // Limit only to developer feature toggles for now.\n    if (keyType !== 'developer' && keyType !== 'user') {\n      return Promise.reject(new Error('Only `developer` and `user` feature toggles can be set.'));\n    }\n\n    return this.request({\n      method: 'POST',\n      api: 'feature',\n      resource: `features/users/${this.webex.internal.device.userId}/${keyType}`,\n      body: {\n        key,\n        mutable: true,\n        val: value,\n      },\n    }).then((res) => this.webex.internal.device.features[keyType].add(res.body, {merge: true}));\n  },\n\n  /**\n   * Issues request to server to set a value for a feature toggle.\n   * @param {array} featureList - in the form of `Array<{ type: 'USER' | 'DEV', key: string, val: any }>`\n   * @returns {Promise} Refreshes the local device and resolves with the features endpoint`s response.\n   */\n  setBundledFeatures(featureList) {\n    featureList.forEach((item) => {\n      item.mutable = item.mutable || 'true';\n      if (item.type !== 'USER' && item.type !== 'DEV') {\n        item.type = 'USER';\n      }\n    });\n\n    return this.request({\n      method: 'POST',\n      api: 'feature',\n      resource: `features/users/${this.webex.internal.device.userId}/toggles`,\n      body: featureList,\n    }).then((res) => {\n      const partitionedToggles = partition(res.body.featureToggles, {type: 'USER'});\n\n      this.webex.internal.device.features.user.add(partitionedToggles[0], {merge: true});\n      this.webex.internal.device.features.developer.add(partitionedToggles[1], {merge: true});\n    });\n  },\n\n  initialize(...args) {\n    Reflect.apply(WebexPlugin.prototype.initialize, this, args);\n\n    this.listenToAndRun(\n      this.webex,\n      'change:internal.device.features.developer',\n      this.trigger.bind(this, 'change:developer')\n    );\n    this.listenToAndRun(\n      this.webex,\n      'change:internal.device.features.entitlement',\n      this.trigger.bind(this, 'change:entitlement')\n    );\n    this.listenToAndRun(\n      this.webex,\n      'change:internal.device.features.user',\n      this.trigger.bind(this, 'change:user')\n    );\n  },\n});\n\nexport default Feature;\n"],"mappings":"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"}